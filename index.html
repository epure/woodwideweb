<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Wood Wide Web</title>
    
    <!-- IBM Plex Mono Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- MindAR & A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'IBM Plex Mono', monospace;
            width: 100vw;
            height: 100vh;
        }
        
        /* Force A-Frame scene to take full screen */
        a-scene {
            width: 100vw !important;
            height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
        }
        
        /* Force canvas to take full screen */
        .a-canvas,
        canvas {
            width: 100vw !important;
            height: 100vh !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
        }
        
        /* √âcran de chargement */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #fff;
        }
        
        #loading-screen.hidden {
            display: none;
        }
        
        .loading-title {
            font-size: 24px;
            font-weight: 500;
            letter-spacing: 2px;
            margin-bottom: 40px;
            text-transform: uppercase;
        }
        
        .loading-text {
            font-size: 14px;
            font-weight: 400;
            letter-spacing: 1px;
            opacity: 0.7;
        }
        
        /* Viseur de d√©tection - 4 angles uniquement */
        #viewfinder {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60vw;
            height: 60vw;
            max-width: 300px;
            max-height: 300px;
            pointer-events: none;
            z-index: 1000;
        }
        
        #viewfinder.hidden {
            display: none;
        }
        
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 2px solid rgba(255, 255, 255, 0.6);
        }
        
        .corner.top-left {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
        }
        
        .corner.top-right {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
        }
        
        .corner.bottom-left {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
        }
        
        .corner.bottom-right {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
        }
        
        /* Barre de progression */
        #progress-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: transparent;
            z-index: 1001;
            display: none;
        }
        
        #progress-bar.active {
            display: block;
        }
        
        #progress-fill {
            height: 100%;
            width: 0%;
            background: #fff;
            transition: width 0.1s linear;
        }
        
        /* Cacher uniquement les boutons/overlays UI de A-Frame */
        .a-enter-vr-button,
        .a-enter-ar-button,
        .a-orientation-modal,
        .a-dialog-container,
        .a-loader-title,
        .a-dialog,
        [data-aframe-default-ui] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        
        /* Cacher la barre blanche horizontale de scan/tracking */
        .mindar-ui-scanning,
        .mindar-ui-scanning-line,
        .scanning-overlay,
        [class*="scanning"],
        [class*="ui-overlay"],
        .mindar-ui-overlay,
        .mindar-ui-loading,
        .mindar-ui-compatibility,
        [class*="mindar-ui"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }
        
        /* Debug overlay pour mobile */
        #debug-overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            font-family: 'IBM Plex Mono', monospace;
            font-size: 10px;
            padding: 10px;
            z-index: 10000;
            overflow-y: auto;
            border: 1px solid #0f0;
            display: none;
        }
        
        #debug-overlay.active {
            display: block;
        }
        
        #debug-overlay .log-line {
            margin: 2px 0;
            word-break: break-all;
        }
        
        #debug-toggle {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            background: rgba(0, 255, 0, 0.3);
            border: 2px solid #0f0;
            border-radius: 50%;
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #0f0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Debug toggle button -->
    <div id="debug-toggle">?</div>
    
    <!-- Debug overlay -->
    <div id="debug-overlay"></div>

    <!-- √âcran de chargement -->
    <div id="loading-screen">
        <div class="loading-title">Wood Wide Web</div>
        <div class="loading-text">Initialisation...</div>
    </div>

    <!-- Viseur de d√©tection -->
    <div id="viewfinder">
        <div class="corner top-left"></div>
        <div class="corner top-right"></div>
        <div class="corner bottom-left"></div>
        <div class="corner bottom-right"></div>
    </div>

    <!-- Barre de progression -->
    <div id="progress-bar">
        <div id="progress-fill"></div>
    </div>

    <!-- Sc√®ne AR -->
    <a-scene 
        mindar-image="
            imageTargetSrc: ./targets.mind;
            maxTrack: 1;
            filterMinCF: 0.0001;
            filterBeta: 0.01;
            missTolerance: 20;
            warmupTolerance: 3
        "
        color-space="sRGB" 
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        embedded
    >
        <!-- Assets -->
        <a-assets>
            <!-- Vid√©o unique pour toutes les ≈ìuvres (test) -->
            <video 
                id="shared-video" 
                src="https://res.cloudinary.com/dmgx02nlp/video/upload/v1770030665/WoodWideWeb_01_kj0sqr.mp4" 
                preload="auto" 
                loop 
                crossorigin="anonymous" 
                playsinline 
                webkit-playsinline
            ></video>
        </a-assets>

        <!-- Cam√©ra -->
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <!-- ≈íuvre 01 -->
        <a-entity id="target-01" mindar-image-target="targetIndex: 0">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 02 -->
        <a-entity id="target-02" mindar-image-target="targetIndex: 1">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 03 -->
        <a-entity id="target-03" mindar-image-target="targetIndex: 2">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 04 -->
        <a-entity id="target-04" mindar-image-target="targetIndex: 3">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 05 -->
        <a-entity id="target-05" mindar-image-target="targetIndex: 4">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 06 -->
        <a-entity id="target-06" mindar-image-target="targetIndex: 5">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 07 -->
        <a-entity id="target-07" mindar-image-target="targetIndex: 6">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 08 -->
        <a-entity id="target-08" mindar-image-target="targetIndex: 7">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 09 -->
        <a-entity id="target-09" mindar-image-target="targetIndex: 8">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 10 -->
        <a-entity id="target-10" mindar-image-target="targetIndex: 9">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 11 -->
        <a-entity id="target-11" mindar-image-target="targetIndex: 10">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 12 -->
        <a-entity id="target-12" mindar-image-target="targetIndex: 11">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 13 -->
        <a-entity id="target-13" mindar-image-target="targetIndex: 12">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 14 -->
        <a-entity id="target-14" mindar-image-target="targetIndex: 13">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 15 -->
        <a-entity id="target-15" mindar-image-target="targetIndex: 14">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 16 -->
        <a-entity id="target-16" mindar-image-target="targetIndex: 15">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 17 -->
        <a-entity id="target-17" mindar-image-target="targetIndex: 16">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 18 -->
        <a-entity id="target-18" mindar-image-target="targetIndex: 17">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 19 -->
        <a-entity id="target-19" mindar-image-target="targetIndex: 18">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 20 -->
        <a-entity id="target-20" mindar-image-target="targetIndex: 19">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 21 -->
        <a-entity id="target-21" mindar-image-target="targetIndex: 20">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 22 -->
        <a-entity id="target-22" mindar-image-target="targetIndex: 21">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 23 -->
        <a-entity id="target-23" mindar-image-target="targetIndex: 22">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>

        <!-- ≈íuvre 24 -->
        <a-entity id="target-24" mindar-image-target="targetIndex: 23">
            <a-video 
                src="#shared-video" 
                width="1" 
                height="1" 
                position="0 0 0"
                smooth-transform="factor: 0.08"
            ></a-video>
        </a-entity>
    </a-scene>

    <script>
        // Syst√®me de debug visuel pour mobile
        let debugOverlay;
        let debugToggle;
        let debugLogs = [];
        const MAX_LOGS = 20;
        
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLogs.push(`[${timestamp}] ${message}`);
            if (debugLogs.length > MAX_LOGS) {
                debugLogs.shift();
            }
            if (debugOverlay) {
                debugOverlay.innerHTML = debugLogs.map(log => 
                    `<div class="log-line">${log}</div>`
                ).join('');
                debugOverlay.scrollTop = debugOverlay.scrollHeight;
            }
            console.log(message); // Toujours logger aussi dans la console
        }
        
        // Composant de smoothing personnalis√© pour r√©duire le jitter
        AFRAME.registerComponent('smooth-transform', {
            schema: {
                factor: { type: 'number', default: 0.08 }
            },
            
            init: function() {
                this.targetPosition = new THREE.Vector3();
                this.targetRotation = new THREE.Euler();
                this.targetScale = new THREE.Vector3(1, 1, 1);
                this.isFirstFrame = true;
            },
            
            tick: function() {
                const obj = this.el.object3D;
                
                if (this.isFirstFrame) {
                    this.targetPosition.copy(obj.position);
                    this.targetRotation.copy(obj.rotation);
                    this.targetScale.copy(obj.scale);
                    this.isFirstFrame = false;
                    return;
                }
                
                // R√©cup√©rer les valeurs cibles
                const tempPos = obj.position.clone();
                const tempRot = obj.rotation.clone();
                
                // Interpoler vers les valeurs cibles
                this.targetPosition.lerp(tempPos, this.data.factor);
                
                // Pour la rotation, utiliser slerp
                const currentQuat = new THREE.Quaternion().setFromEuler(this.targetRotation);
                const targetQuat = new THREE.Quaternion().setFromEuler(tempRot);
                currentQuat.slerp(targetQuat, this.data.factor);
                this.targetRotation.setFromQuaternion(currentQuat);
                
                // Appliquer les valeurs liss√©es
                obj.position.copy(this.targetPosition);
                obj.rotation.copy(this.targetRotation);
            }
        });
        
        // Gestion des √©v√©nements de d√©tection avec vid√©o partag√©e
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser le syst√®me de debug
            debugOverlay = document.getElementById('debug-overlay');
            debugToggle = document.getElementById('debug-toggle');
            
            debugToggle.addEventListener('click', () => {
                debugOverlay.classList.toggle('active');
            });
            
            debugLog('=== APPLICATION D√âMARR√âE ===');
            
            const loadingScreen = document.getElementById('loading-screen');
            const viewfinder = document.getElementById('viewfinder');
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            const sceneEl = document.querySelector('a-scene');
            
            // Cacher l'√©cran de chargement quand l'AR est pr√™t
            sceneEl.addEventListener('arReady', () => {
                debugLog('MindAR pr√™t');
                loadingScreen.classList.add('hidden');
            });
            
            // R√©f√©rence √† la vid√©o partag√©e
            const sharedVideo = document.getElementById('shared-video');
            
            if (!sharedVideo) {
                debugLog('ERREUR: Vid√©o partag√©e introuvable!');
                return;
            }
            
            debugLog('Vid√©o trouv√©e: ' + sharedVideo.src);
            
            // Compteur de d√©tections pour debug
            let detectionCount = 0;
            
            // Mettre √† jour la barre de progression
            function updateProgress() {
                if (sharedVideo && !sharedVideo.paused && sharedVideo.duration > 0) {
                    const progress = (sharedVideo.currentTime / sharedVideo.duration) * 100;
                    progressFill.style.width = progress + '%';
                    // Log toutes les 2 secondes seulement
                    if (Math.floor(sharedVideo.currentTime) % 2 === 0 && sharedVideo.currentTime > 0) {
                        debugLog(`Progression: ${progress.toFixed(0)}%`);
                    }
                } else {
                    // Debug : pourquoi updateProgress ne met pas √† jour ?
                    if (isTargetFound && sharedVideo) {
                        if (sharedVideo.paused) {
                            debugLog('‚ö†Ô∏è updateProgress: vid√©o en PAUSE');
                        } else if (sharedVideo.duration <= 0) {
                            debugLog('‚ö†Ô∏è updateProgress: duration invalide');
                        }
                    }
                }
            }
            
            // √âcouter les changements de temps de la vid√©o
            sharedVideo.addEventListener('timeupdate', updateProgress);
            
            // Variable pour suivre l'√©tat de d√©tection
            let isTargetFound = false;
            let currentVideoElement = null;
            let progressBarHideTimeout = null; // Timeout pour retarder le masquage de la barre
            
            // Gestion de la lecture/pause vid√©o pour chaque ≈ìuvre
            for (let i = 1; i <= 24; i++) {
                const targetId = `target-${String(i).padStart(2, '0')}`;
                const target = document.getElementById(targetId);
                
                if (target) {
                    // R√©cup√©rer l'√©l√©ment vid√©o dans ce target
                    const videoElement = target.querySelector('a-video');
                    
                    if (!videoElement) {
                        debugLog(`ERREUR: VideoElement ${i} introuvable!`);
                        continue;
                    }
                    
                    // Initialiser la vid√©o invisible
                    videoElement.setAttribute('opacity', 0);
                    videoElement.setAttribute('material', 'opacity: 0');
                    
                    // Quand l'image est d√©tect√©e
                    target.addEventListener('targetFound', () => {
                        detectionCount++;
                        debugLog(`>>> D√âTECTION #${detectionCount} - ≈íuvre ${i}`);
                        isTargetFound = true;
                        currentVideoElement = videoElement;
                        
                        // IMPORTANT : Annuler tout timeout de masquage de barre en cours
                        if (progressBarHideTimeout) {
                            clearTimeout(progressBarHideTimeout);
                            progressBarHideTimeout = null;
                            debugLog('‚ö° Timeout masquage barre ANNUL√â');
                        }
                        
                        // 1. Masquer le viseur
                        viewfinder.classList.add('hidden');
                        debugLog('Viseur masqu√©');
                        
                        // 2. Afficher la barre de progression (FORCER)
                        progressBar.classList.add('active');
                        progressBar.style.display = 'block'; // FORCER avec style direct
                        progressFill.style.width = '0%';
                        // V√©rifier que la classe est bien ajout√©e
                        const hasActive = progressBar.classList.contains('active');
                        const displayStyle = window.getComputedStyle(progressBar).display;
                        debugLog(`Barre FORC√âE: active=${hasActive}, display=${displayStyle}`);
                        
                        // 3. Afficher la vid√©o imm√©diatement
                        videoElement.setAttribute('opacity', 1);
                        videoElement.setAttribute('material', 'opacity: 1');
                        debugLog('Vid√©o opacit√© = 1');
                        
                        // 4. RESET et LECTURE de la vid√©o avec d√©lai
                        try {
                            // Reset imm√©diat
                            debugLog('Reset vid√©o...');
                            sharedVideo.pause();
                            sharedVideo.currentTime = 0;
                            progressFill.style.width = '0%';
                            
                            // Attendre un peu plus longtemps pour √™tre s√ªr que le reset est pris en compte
                            setTimeout(() => {
                                debugLog('Tentative de lecture...');
                                
                                // V√©rifier l'√©tat avant play
                                debugLog(`ReadyState: ${sharedVideo.readyState}, Paused: ${sharedVideo.paused}`);
                                
                                sharedVideo.play()
                                    .then(() => {
                                        debugLog('‚úì Vid√©o lanc√©e OK');
                                        // V√©rifier imm√©diatement apr√®s
                                        setTimeout(() => {
                                            debugLog(`V√©rif: Paused=${sharedVideo.paused}, Time=${sharedVideo.currentTime.toFixed(2)}s`);
                                            
                                            // V√©rifier √† nouveau la barre
                                            const stillActive = progressBar.classList.contains('active');
                                            const stillDisplay = window.getComputedStyle(progressBar).display;
                                            debugLog(`Barre apr√®s play: active=${stillActive}, display=${stillDisplay}`);
                                            
                                            // V√âRIFICATIONS SUPPL√âMENTAIRES pour d√©tecter disparition
                                            setTimeout(() => {
                                                const check500 = progressBar.classList.contains('active');
                                                const display500 = window.getComputedStyle(progressBar).display;
                                                debugLog(`[500ms] Barre: active=${check500}, display=${display500}`);
                                                if (!check500 || display500 === 'none') {
                                                    debugLog('‚ö†Ô∏è‚ö†Ô∏è BARRE DISPARUE √† 500ms ! Remise FORC√âE');
                                                    progressBar.classList.add('active');
                                                    progressBar.style.display = 'block';
                                                }
                                            }, 500);
                                            
                                            setTimeout(() => {
                                                const check1000 = progressBar.classList.contains('active');
                                                const display1000 = window.getComputedStyle(progressBar).display;
                                                debugLog(`[1000ms] Barre: active=${check1000}, display=${display1000}`);
                                                if (!check1000 || display1000 === 'none') {
                                                    debugLog('‚ö†Ô∏è‚ö†Ô∏è BARRE DISPARUE √† 1000ms ! Remise FORC√âE');
                                                    progressBar.classList.add('active');
                                                    progressBar.style.display = 'block';
                                                }
                                            }, 1000);
                                            
                                            // Si la vid√©o est toujours en pause apr√®s 200ms, forcer encore
                                            if (sharedVideo.paused) {
                                                debugLog('‚ö†Ô∏è Vid√©o encore en pause, nouvelle tentative...');
                                                sharedVideo.play().catch(err => {
                                                    debugLog('‚úó 2√®me tentative √©chou√©e: ' + err.message);
                                                });
                                            }
                                        }, 200);
                                    })
                                    .catch(err => {
                                        debugLog('‚úó ERREUR play: ' + err.message);
                                        // R√©essayer apr√®s d√©lai plus long
                                        setTimeout(() => {
                                            debugLog('Nouvelle tentative apr√®s erreur...');
                                            sharedVideo.play().catch(err2 => {
                                                debugLog('‚úó √âchec d√©finitif: ' + err2.message);
                                            });
                                        }, 300);
                                    });
                            }, 100); // Augment√© √† 100ms
                            
                        } catch(e) {
                            debugLog('‚úó EXCEPTION: ' + e.message);
                        }
                    });
                    
                    // Quand l'image est perdue
                    target.addEventListener('targetLost', () => {
                        debugLog(`<<< PERTE - ≈íuvre ${i}`);
                        isTargetFound = false;
                        currentVideoElement = null;
                        
                        // Cacher la vid√©o imm√©diatement
                        videoElement.setAttribute('opacity', 0);
                        videoElement.setAttribute('material', 'opacity: 0');
                        
                        // R√©afficher le viseur
                        viewfinder.classList.remove('hidden');
                        
                        // Masquer la barre de progression AVEC D√âLAI
                        // (au cas o√π une nouvelle d√©tection arrive juste apr√®s)
                        const hadActive = progressBar.classList.contains('active');
                        debugLog(`Barre: avant perte active=${hadActive}`);
                        
                        // Annuler l'ancien timeout s'il existe
                        if (progressBarHideTimeout) {
                            clearTimeout(progressBarHideTimeout);
                        }
                        
                        // Programmer le masquage dans 300ms
                        progressBarHideTimeout = setTimeout(() => {
                            debugLog(`üîî TIMEOUT EX√âCUT√â (300ms √©coul√©es)`);
                            // Ne masquer que si aucune nouvelle d√©tection n'a eu lieu
                            if (!isTargetFound) {
                                progressBar.classList.remove('active');
                                progressBar.style.display = ''; // Retirer aussi le style inline
                                const hasActiveAfter = progressBar.classList.contains('active');
                                const displayAfter = window.getComputedStyle(progressBar).display;
                                debugLog(`‚úì‚úì BARRE RETIR√âE: active=${hasActiveAfter}, display=${displayAfter}`);
                            } else {
                                debugLog('‚ö°‚ö° Barre CONSERV√âE (isTargetFound=true)');
                            }
                            progressBarHideTimeout = null;
                        }, 300);
                        
                        debugLog('Barre: masquage programm√© dans 300ms');
                        
                        // NE PAS toucher √† sharedVideo ici !
                        // Le reset sera fait au prochain targetFound
                        debugLog('Vid√©o cach√©e (pas de pause)');
                    });
                }
            }
            
            // Logs p√©riodiques de l'√©tat vid√©o
            setInterval(() => {
                if (isTargetFound && sharedVideo) {
                    debugLog(`√âtat: paused=${sharedVideo.paused}, time=${sharedVideo.currentTime.toFixed(1)}s/${sharedVideo.duration.toFixed(1)}s`);
                }
            }, 3000);
        });
    </script>
</body>
</html>
